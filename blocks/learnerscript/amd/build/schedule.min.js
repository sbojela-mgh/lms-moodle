define ("block_learnerscript/schedule",["jquery","core/ajax","block_learnerscript/ajax","core/event","block_learnerscript/select2","block_learnerscript/report","core/str"],function(a,b,c,d,e,f,g){return schedule={schreportform:function schreportform(c){var d=b.call([{methodname:"block_learnerscript_schreportform",args:{reportid:c.reportid,instance:c.instanceid}}]);d[0].done(function(b){b=a.parseJSON(b);a("body").append("<div class='schreportform"+c.instanceid+"'>"+b+"</div>");var d="<img class='dialog_title_icon' alt='Scheduled Report' src='"+M.util.image_url("schedule_icon","block_learnerscript")+"'/>",e=a(".schreportform"+c.instanceid).dialog({resizable:!0,autoOpen:!1,width:"90%",title:"Add schedule report",modal:!0,appendTo:"#inst"+c.instanceid,position:{my:"center",at:"center",of:"#reportcontainer"+c.instanceid},open:function open(){a(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var b=a(".ui-icon-closethick").parent();a(b).attr({title:"Close"});a(this).closest(".ui-dialog").find(".ui-dialog-title").html(d+"Schedule report")},close:function close(){a(this).dialog("destroy").remove()}});e.dialog("open");a("#id_role"+c.instanceid).select2();this.SelectRoleUsers();this.schformvalidation({reportid:c.reportid,form:"schform"+c.instanceid,reqclass:"schformreq"+c.instanceid,instanceid:c.instanceid})}).fail(function(){})},ScheduledTimings:function ScheduledTimings(b){a("select[data-select2='1']").select2({theme:"classic"});this.SelectRoleUsers();a("#scheduledtimings").dataTable({processing:!0,serverSide:!0,lengthMenu:[[5,10,25,50,-1],[5,10,25,50,"All"]],idisplaylength:5,ordering:!1,ajax:{method:"GET",url:M.cfg.wwwroot+"/blocks/learnerscript/components/scheduler/ajax.php",data:b}})},ViewSchUsersTable:function ViewSchUsersTable(b){a("#scheduledusers").dataTable({processing:!0,serverSide:!0,lengthMenu:[[5,10,25,50,-1],[5,10,25,50,"All"]],idisplaylength:5,ordering:!1,ajax:{method:"GET",url:M.cfg.wwwroot+"/blocks/learnerscript/components/scheduler/ajax.php",data:{action:"viewschusersdata",reportid:b.reportid,scheduleid:b.scheduleid,schuserslist:b.schuserslist}}})},schformvalidation:function schformvalidation(a){document.getElementById(a.form).addEventListener("submit",function(b){try{var c=f.validate_scheduled_reports_form(a)}catch(a){return!0}if("undefined"!=typeof window.tinyMCE){window.tinyMCE.triggerSave()}if(!c){b.preventDefault()}return!1})},validate_scheduled_reports_form:function validate_scheduled_reports_form(b){var c=this;if(skipClientValidation){a(".schreportform"+b.instanceid).dialog("destroy").remove()}var d=!0,e=document.getElementById(b.form),f=!1;a("[data-class='"+b.reqclass+"']").each(function(e,g){var h=a(g).data("element");d=c.validate_scheduled_reports_form_element(g,h,b)&&d;if(!d&&!f){f=!0;Y.use("moodle-core-event",function(){Y.Global.fire(M.core.globalEvents.FORM_ERROR,{formid:b.form,elementid:"id_error_"+h+b.instanceid});document.getElementById("id_error_"+h+b.instanceid).focus()})}});return d},validate_scheduled_reports_form_element:function validate_scheduled_reports_form_element(a,b,c){if(void 0==a){return!0}var d="",e=[],f="",g=a.parentNode;if(void 0!=a.name&&g!=void 0){while(g&&"FORM"!=g.nodeName.toUpperCase()){g=g.parentNode}d=[];for(var h=0,j=0;j<a.options.length;j++){if(a.options[j].selected){d[h++]=a.options[j].value}}if(""==d&&!e[b]){e[b]=!0;f=f+" - You must supply a value here."}return this.qf_errorHandler(a,f,b,c)}else{return!0}},qf_errorHandler:function qf_errorHandler(b,c,e,f){var g=a.Event(d.Events.FORM_FIELD_VALIDATION);a(b).trigger(g,c);if(g.isDefaultPrevented()){return""==c}else{var h=b.parentNode;if(h==void 0||b.name==void 0){return!0}if(""!=c){var i=document.getElementById("id_error_"+e+f.instanceid);if(!i){i=document.createElement("span");i.id="id_error_"+e+f.instanceid;i.className="error";b.parentNode.insertBefore(i,b.parentNode.firstChild);document.getElementById(i.id).setAttribute("TabIndex","0");document.getElementById(i.id).focus()}while(i.firstChild){i.removeChild(i.firstChild)}i.appendChild(document.createTextNode(c.substring(3)));if(" error"!=h.className.substr(h.className.length-6,6)&&"error"!=h.className){h.className+=" error";j=document.createElement("br");j.className="error";j.id="id_error_break_"+e+f.instanceid;i.parentNode.insertBefore(j,i.nextSibling)}return!1}else{var i=document.getElementById("id_error_"+e+f.instanceid);if(i){i.parentNode.removeChild(i)}var j=document.getElementById("id_error_break_"+e+f.instanceid);if(j){j.parentNode.removeChild(j)}if(" error"==h.className.substr(h.className.length-6,6)){h.className=h.className.substr(0,h.className.length-6)}else if("error"==h.className){h.className=""}return!0}}},frequency_schedule:function frequency_schedule(c){var d=b.call([{methodname:"block_learnerscript_frequency_schedule",args:{frequency:a("#id_frequency"+c.reportinstance).val()}}]);d[0].done(function(b){b=a.parseJSON(b);var d="";if(b){a.each(b,function(a,b){d+="<option value = "+a+" >"+b+"</option>"})}else{d+="<option value=null > --SELECT-- </option>"}a("#id_updatefrequency"+c.reportinstance).html(d)}).fail(function(){})},manageschusers:function manageschusers(c){g.get_string("manageschusers","block_learnerscript").then(function(){var d=b.call([{methodname:"block_learnerscript_manageschusers",args:{reportid:c.reportid,scheduleid:c.scheduleid,selectedroleid:JSON.stringify(c.selectedroleid),schuserslist:c.schuserslist,reportinstance:c.reportinstance}}]);d[0].done(function(b){b=a.parseJSON(b);a("body").append("<div class='manageschusers'>"+b+"</div>");var d=a("body").attr("id"),e,f,g;if("page-blocks-learnerscript-components-scheduler-schedule"==d){e="#scheduleform";f="center top";g="center top"}else{e=window;f="center";g="center";a(".manageschusers").addClass("notschuserspage")}var h=a(".manageschusers").dialog({resizable:!0,autoOpen:!1,width:"60%",title:"Manage Schedule Users",modal:!0,position:{my:f,at:g,of:e,within:e},close:function close(){a(this).dialog("destroy").remove()},open:function open(){a(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var b=a(".ui-icon-closethick").parent();a(b).attr({title:"Close"})}});if(a(".manageschusers").hasClass("notschuserspage")){var i=a(".manageschusers").parent();i.addClass("notinschpage")}a(".selectrole"+c.reportid).select2();h.dialog("open")}).fail(function(){})})},getroleusers:function getroleusers(c){var d=a(".selectrole"+c.reportid).val();this.validate_scheduled_reports_form({reportid:c.reportid,form:"assignform",reqclass:"rolereq"});var e=a(".removeselect").val();if(1>a("#addselect_searchtext").val().length){template="<optgroup label='Enter a value in search.'></optgroup>";a("#"+c.type+"select"+c.reportid).html(template)}else{var f=d.split("_");c.roleid=f[0];c.contextlevel=f[1];var g=b.call([{methodname:"block_learnerscript_roleusers",args:{term:a("#addselect_searchtext").val(),type:c.type,reportid:c.reportid,roleid:c.roleid,contextlevel:c.contextlevel,scheduleid:c.scheduleid,bullkselectedusers:JSON.stringify(e)}}]);g[0].done(function(b){var d="";b=a.parseJSON(b);if(0<b.total_count){a.each(b.items,function(a,b){d+="<option value = "+b.id+" >"+b.fullname+"</option>"})}else{d+="<optgroup label='No results found.'></optgroup>"}a("#"+c.type+"select"+c.reportid).html(d)}).fail(function(){})}},bulkmanageschusers:function bulkmanageschusers(b){var c=a.map(a(".removeselect option"),function(a){return a.value});a("#schuserslist"+b.reportinstance).val(c);var d=a(".removeselect").find("option").clone();a("#id_users_data"+b.reportinstance).children("option").remove();if(10<d.length){var e=d.slice(0,10);e.attr("selected","selected").appendTo("#id_users_data"+b.reportinstance);var f=document.createElement("option");f.value="-1";f.innerHTML="View More";f.selected=!0;document.getElementById("id_users_data"+b.reportinstance).appendChild(f)}else{a(".removeselect").find("option").clone().attr("selected","selected").appendTo("#id_users_data"+b.reportinstance)}a(".manageschusers").dialog("close")},viewschusers:function viewschusers(b){g.get_string("viewschusers","block_learnerscript").then(function(){this;b.schuserslist=a("#schuserslist"+b.reportinstance).val();var d=c.call({methodname:"viewschuserstable",args:{action:"viewschuserstable",reportid:b.reportid,scheduleid:b.scheduleid,schuserslist:b.schuserslist},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"});d.done(function(c){a("body").append("<div class='viewschuserstable'>"+c+"</div>");var d=a(".viewschuserstable").dialog({resizable:!0,autoOpen:!1,width:"60%",title:"View Scheduled Users",modal:!0,close:function close(){a(this).dialog("destroy").remove()},open:function open(){a(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var b=a(".ui-icon-closethick").parent();a(b).attr({title:"Close"})}});schedule.ViewSchUsersTable(b);d.dialog("open").prev(".ui-dialog-titlebar").css("color","#0C75B6")}).fail(function(){})})},addschusers:function addschusers(b){var c=a(".schforms"+b.reportinstance+" #id_users_data"+b.reportinstance).val(),e=a(".schforms"+b.reportinstance+" #schuserslist"+b.reportinstance).val(),f;if(e){e=e.split(",");f=e.concat(c)}else{f=c}if(f&&f.includes("-1")){var g=f.indexOf("-1");f.splice(g,1)}a("#id_users_data"+b.reportinstance).find("option").not(":selected").each(function(a,b){if(f&&f.includes(b.value)){var c=f.indexOf(b.value);f.splice(c,1)}});var h=f&&f.filter(function(a,b){return f.indexOf(a)==b});a("#schuserslist"+b.reportinstance).val(h)},SelectRoleUsers:function SelectRoleUsers(){var b=a(".schform").data("reportid");require(["block_learnerscript/helper"],function(a){a.Select2Ajax({reportid:b,action:"rolewiseusers",maximumSelectionLength:10})})},rolewiseusers:function rolewiseusers(b){a("#id_users_data"+b.reportinstance).val(null).trigger("change")}}});
//# sourceMappingURL=schedule.min.js.map
