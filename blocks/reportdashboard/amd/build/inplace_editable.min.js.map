{"version":3,"sources":["../src/inplace_editable.js"],"names":["define","$","ajax","templates","notification","str","cfg","url","on","e","type","keyCode","stopImmediatePropagation","preventDefault","target","mainelement","closest","addSpinner","element","addClass","spinner","find","length","show","attr","imageUrl","append","removeSpinner","removeClass","hide","updateValue","value","call","methodname","args","prevoiusdashboardname","pagetypepattern","subpagepattern","done","data","roleshortname","window","location","href","M","wwwroot","fail","ex","Event","exception","newvalue","trigger","isDefaultPrevented","turnEditingOff","el","off","html","removeAttr","focus","uniqueId","prefix","idlength","uniqid","i","Math","floor","random","turnEditingOnText","get_string","s","instr","inputelement","lbl","select","behatsiterunning","val","turnEditingOnToggle","turnEditingOnSelect","options","key","turnEditingOffEverywhere","each","turnEditingOn","parseJSON"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AJAX helper for the inline editing a value.\n *\n * This script is automatically included from template core/inplace_editable\n * It registers a click-listener on [data-inplaceeditablelink] link (the \"inplace edit\" icon),\n * then replaces the displayed value with an input field. On \"Enter\" it sends a request\n * to web service core_update_inplace_editable, which invokes the specified callback.\n * Any exception thrown by the web service (or callback) is displayed as an error popup.\n *\n * @module     core/inplace_editable\n * @package    core\n * @copyright  2016 Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.1\n */\ndefine(['jquery', 'core/ajax', 'core/templates', 'core/notification', 'core/str', 'core/config', 'core/url'],\n        function($, ajax, templates, notification, str, cfg, url) {\n\n    $('body').on('click keypress', '[data-inplaceeditable] [data-inplaceeditablelink]', function(e) {\n        if (e.type === 'keypress' && e.keyCode !== 13) {\n            return;\n        }\n        e.stopImmediatePropagation();\n        e.preventDefault();\n        var target = $(this),\n            mainelement = target.closest('[data-inplaceeditable]');\n\n        var addSpinner = function(element) {\n            element.addClass('updating');\n            var spinner = element.find('img.spinner');\n            if (spinner.length) {\n                spinner.show();\n            } else {\n                spinner = $('<img/>')\n                        .attr('src', url.imageUrl('i/loading_small'))\n                        .addClass('spinner').addClass('smallicon')\n                    ;\n                element.append(spinner);\n            }\n        };\n\n        var removeSpinner = function(element) {\n            element.removeClass('updating');\n            element.find('img.spinner').hide();\n        };\n\n        var updateValue = function(mainelement, value) {\n            addSpinner(mainelement);\n            ajax.call([{\n                    methodname: 'block_reportdashboard_inplace_editable_dashboard',\n                    args: {\n                        prevoiusdashboardname: mainelement.attr('data-prevoiusdashboardname'),\n                        pagetypepattern: mainelement.attr('data-pagetypepattern'),\n                        subpagepattern: mainelement.attr('data-subpagepattern'),\n                        // component: mainelement.attr('data-component'),\n                        // itemtype: mainelement.attr('data-itemtype'),\n                        value: value\n                    },\n                    done: function(data) {\n                        var roleshortname = mainelement.attr('data-roleshortname');\n\n                        // templates.render('core/inplace_editable', data).done(function(html, js) {\n                        //     var newelement = $(html);\n                        //     templates.replaceNode(mainelement, newelement, js);\n                        //     newelement.find('[data-inplaceeditablelink]').focus();\n                        //     newelement.trigger({type: 'updated', ajaxreturn: data, oldvalue: oldvalue});\n                        // });\n                        if(roleshortname == ''){\n                            window.location.href = M.cfg.wwwroot+'/blocks/reportdashboard/dashboard.php?dashboardurl='+data;\n                        } else{\n                            window.location.href = M.cfg.wwwroot+'/blocks/reportdashboard/dashboard.php?dashboardurl='+data+'&role='+roleshortname;\n                        }\n                    },\n                    fail: function(ex) {\n                        var e = $.Event('updatefailed', {\n                                exception: ex,\n                                newvalue: value\n                            });\n                        removeSpinner(mainelement);\n                        mainelement.trigger(e);\n                        if (!e.isDefaultPrevented()) {\n                            notification.exception(ex);\n                        }\n                    }\n                }], true);\n        };\n\n        var turnEditingOff = function(el) {\n            el.find('input').off();\n            el.find('select').off();\n            el.html(el.attr('data-oldcontent'));\n            el.removeAttr('data-oldcontent');\n            el.removeClass('inplaceeditingon');\n            el.find('[data-inplaceeditablelink]').focus();\n        };\n\n        var turnEditingOffEverywhere = function() {\n            $('span.inplaceeditable.inplaceeditingon').each(function() {\n                turnEditingOff($(this));\n            });\n        };\n\n        var uniqueId = function(prefix, idlength) {\n            var uniqid = prefix,\n                i;\n            for (i = 0; i < idlength; i++) {\n                uniqid += String(Math.floor(Math.random() * 10));\n            }\n            // Make sure this ID is not already taken by an existing element.\n            if ($(\"#\" + uniqid).length === 0) {\n                return uniqid;\n            }\n            return uniqueId(prefix, idlength);\n        };\n\n        var turnEditingOnText = function(el) {\n            str.get_string('edittitleinstructions').done(function(s) {\n                var instr = $('<span class=\"editinstructions\">' + s + '</span>').\n                        attr('id', uniqueId('id_editinstructions_', 20)),\n                    inputelement = $('<input type=\"text\"/>').\n                        attr('id', uniqueId('id_inplacevalue_', 20)).\n                        attr('value', el.attr('data-value')).\n                        attr('aria-describedby', instr.attr('id')).\n                        addClass('ignoredirty').\n                        addClass('form-control'),\n                    lbl = $('<label class=\"accesshide\">' + mainelement.attr('data-editlabel') + '</label>').\n                        attr('for', inputelement.attr('id'));\n                el.html('').append(instr).append(lbl).append(inputelement);\n\n                inputelement.focus();\n                inputelement.select();\n                inputelement.on('keyup keypress focusout', function(e) {\n                    if (cfg.behatsiterunning && e.type === 'focusout') {\n                        // Behat triggers focusout too often.\n                        return;\n                    }\n                    if (e.type === 'keypress' && e.keyCode === 13) {\n                        // We need 'keypress' event for Enter because keyup/keydown would catch Enter that was\n                        // pressed in other fields.\n                        var val = inputelement.val();\n                        turnEditingOff(el);\n                        updateValue(el, val);\n                    }\n                    if ((e.type === 'keyup' && e.keyCode === 27) || e.type === 'focusout') {\n                        // We need 'keyup' event for Escape because keypress does not work with Escape.\n                        turnEditingOff(el);\n                    }\n                });\n            });\n        };\n\n        var turnEditingOnToggle = function(el, newvalue) {\n            turnEditingOff(el);\n            updateValue(el, newvalue);\n        };\n\n        var turnEditingOnSelect = function(el, options) {\n            var i,\n                inputelement = $('<select></select>').\n                    attr('id', uniqueId('id_inplacevalue_', 20)).\n                    addClass('custom-select'),\n                lbl = $('<label class=\"accesshide\">' + mainelement.attr('data-editlabel') + '</label>')\n                    .attr('for', inputelement.attr('id'));\n            for (i in options) {\n                inputelement\n                    .append($('<option>')\n                    .attr('value', options[i].key)\n                    .html(options[i].value));\n            }\n            inputelement.val(el.attr('data-value'));\n            el.html('')\n                .append(lbl)\n                .append(inputelement);\n\n            inputelement.focus();\n            inputelement.select();\n            inputelement.on('keyup change focusout', function(e) {\n                if (cfg.behatsiterunning && e.type === 'focusout') {\n                    // Behat triggers focusout too often.\n                    return;\n                }\n                if (e.type === 'change') {\n                    var val = inputelement.val();\n                    turnEditingOff(el);\n                    updateValue(el, val);\n                }\n                if ((e.type === 'keyup' && e.keyCode === 27) || e.type === 'focusout') {\n                    // We need 'keyup' event for Escape because keypress does not work with Escape.\n                    turnEditingOff(el);\n                }\n            });\n        };\n\n        var turnEditingOn = function(el) {\n            el.addClass('inplaceeditingon');\n            el.attr('data-oldcontent', el.html());\n\n            var type = el.attr('data-type');\n            var options = el.attr('data-options');\n\n            if (type === 'toggle') {\n                turnEditingOnToggle(el, options);\n            } else if (type === 'select') {\n                turnEditingOnSelect(el, $.parseJSON(options));\n            } else {\n                turnEditingOnText(el);\n            }\n        };\n\n        // Turn editing on for the current element and register handler for Enter/Esc keys.\n        turnEditingOffEverywhere();\n        turnEditingOn(mainelement);\n\n    });\n\n    return {};\n});\n"],"file":"inplace_editable.min.js"}